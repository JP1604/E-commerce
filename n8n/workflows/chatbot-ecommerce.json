{
  "name": "E-commerce Chatbot",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "chatbot",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "chatbot-webhook"
    },
    {
      "parameters": {
        "rules": {
          "rules": [
            {
              "conditions": {
                "string": [
                  {
                    "value1": "={{$json.body.message.toLowerCase()}}",
                    "operation": "contains",
                    "value2": "productos"
                  }
                ]
              }
            },
            {
              "conditions": {
                "string": [
                  {
                    "value1": "={{$json.body.message.toLowerCase()}}",
                    "operation": "contains",
                    "value2": "carrito"
                  }
                ]
              }
            },
            {
              "conditions": {
                "string": [
                  {
                    "value1": "={{$json.body.message.toLowerCase()}}",
                    "operation": "contains",
                    "value2": "orden"
                  }
                ]
              }
            },
            {
              "conditions": {
                "string": [
                  {
                    "value1": "={{$json.body.message.toLowerCase()}}",
                    "operation": "contains",
                    "value2": "pagar"
                  }
                ]
              }
            },
            {
              "conditions": {
                "string": [
                  {
                    "value1": "={{$json.body.message.toLowerCase()}}",
                    "operation": "contains",
                    "value2": "ayuda"
                  }
                ]
              }
            }
          ]
        }
      },
      "id": "switch-commands",
      "name": "Identificar Comando",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "url": "http://product_service:8000/api/v1/products/",
        "options": {}
      },
      "id": "get-products",
      "name": "Obtener Productos",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [650, 100]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "response",
              "value": "=ğŸ›ï¸ **Productos Disponibles:**\n\n{{$json.map((p, i) => `${i+1}. **${p.name}** - $${p.price}\n   ğŸ“¦ Stock: ${p.stock} unidades\n   ID: ${p.id}`).join('\\n\\n')}}\n\nğŸ’¬ Para agregar al carrito escribe: \"agregar [product_id]\""
            }
          ]
        },
        "options": {}
      },
      "id": "format-products",
      "name": "Formatear Productos",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [850, 100]
    },
    {
      "parameters": {
        "url": "=http://cart_service:8003/api/v1/carts/user/{{$('Webhook').item.json.body.user_id}}",
        "options": {}
      },
      "id": "get-cart",
      "name": "Obtener Carrito",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [650, 250]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "response",
              "value": "=ğŸ›’ **Tu Carrito:**\n\n{{$json.items && $json.items.length > 0 ? $json.items.map((item, i) => `${i+1}. ${item.product_name || 'Producto'} x${item.quantity}\n   ğŸ’° Precio: $${item.price}\n   ğŸ“Š Subtotal: $${item.price * item.quantity}`).join('\\n\\n') + '\\n\\nğŸ’µ **Total: $' + $json.items.reduce((sum, item) => sum + (item.price * item.quantity), 0) + '**' : 'Â¡Tu carrito estÃ¡ vacÃ­o! ğŸ˜Š\\n\\nEscribe \"ver productos\" para empezar a comprar.'}} \n\nğŸ’¬ Escribe \"crear orden\" para continuar"
            }
          ]
        },
        "options": {}
      },
      "id": "format-cart",
      "name": "Formatear Carrito",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [850, 250]
    },
    {
      "parameters": {
        "url": "=http://order_service:8005/api/v1/orders/user/{{$('Webhook').item.json.body.user_id}}",
        "options": {}
      },
      "id": "get-orders",
      "name": "Obtener Ã“rdenes",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [650, 400]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "response",
              "value": "=ğŸ“¦ **Tus Ã“rdenes:**\n\n{{$json.length > 0 ? $json.map((order, i) => `${i+1}. **Orden #${order.id.slice(0,8)}**\n   ğŸ“… Fecha: ${new Date(order.created_at).toLocaleDateString()}\n   ğŸ’° Total: $${order.total_amount}\n   ğŸ“Š Estado: ${order.status}\n   ğŸ†” ID: ${order.id}`).join('\\n\\n') : 'Â¡No tienes Ã³rdenes aÃºn! ğŸ˜Š\\n\\nEscribe \"ver productos\" para empezar a comprar.'}}\n\nğŸ’¬ Para ver detalles escribe: \"estado orden [order_id]\""
            }
          ]
        },
        "options": {}
      },
      "id": "format-orders",
      "name": "Formatear Ã“rdenes",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [850, 400]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "response",
              "value": "ğŸ’³ **Procesar Pago**\n\nPara procesar el pago de tu orden, por favor proporciona:\n\n1ï¸âƒ£ ID de la orden\n2ï¸âƒ£ MÃ©todo de pago (credit_card, debit_card, paypal, bank_transfer, cash)\n\nEjemplo: \"pagar [order_id] con credit_card\"\n\nğŸ’¬ Â¿Necesitas ayuda? Escribe \"ayuda\""
            }
          ]
        },
        "options": {}
      },
      "id": "format-payment",
      "name": "Instrucciones de Pago",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [650, 550]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "response",
              "value": "ğŸ¤– **Bienvenido al Asistente Virtual de E-commerce**\n\nÂ¿En quÃ© puedo ayudarte hoy? Estos son los comandos disponibles:\n\nğŸ›ï¸ **Productos**\nâ€¢ \"ver productos\" - Lista todos los productos\nâ€¢ \"buscar [nombre]\" - Busca productos especÃ­ficos\n\nğŸ›’ **Carrito**\nâ€¢ \"agregar [product_id]\" - Agrega producto al carrito\nâ€¢ \"ver carrito\" - Muestra tu carrito actual\nâ€¢ \"vaciar carrito\" - Limpia tu carrito\n\nğŸ“¦ **Ã“rdenes**\nâ€¢ \"crear orden\" - Crea orden con tu carrito\nâ€¢ \"mis Ã³rdenes\" - Lista todas tus Ã³rdenes\nâ€¢ \"estado orden [order_id]\" - Consulta estado de una orden\n\nğŸ’³ **Pagos**\nâ€¢ \"pagar orden [order_id]\" - Procesa el pago\nâ€¢ \"mÃ©todos de pago\" - Muestra opciones de pago\n\nâ“ **Ayuda**\nâ€¢ \"ayuda\" - Muestra este menÃº\nâ€¢ \"soporte\" - Contacta con soporte\n\nğŸ’¬ Â¿QuÃ© te gustarÃ­a hacer?"
            }
          ]
        },
        "options": {}
      },
      "id": "format-help",
      "name": "MenÃº de Ayuda",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [650, 700]
    },
    {
      "parameters": {
        "respondWith": "allIncomingItems",
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Responder al Usuario",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "response",
              "value": "=âŒ **Lo siento, no entendÃ­ tu mensaje**\n\n\"{{$('Webhook').item.json.body.message}}\"\n\nPor favor, intenta con uno de estos comandos:\nâ€¢ ver productos\nâ€¢ ver carrito\nâ€¢ mis Ã³rdenes\nâ€¢ ayuda\n\nğŸ’¬ Â¿En quÃ© puedo ayudarte?"
            }
          ]
        },
        "options": {}
      },
      "id": "default-response",
      "name": "Respuesta Predeterminada",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [650, 850]
    }
  ],
  "connections": {
    "Webhook": {
      "main": [
        [
          {
            "node": "Identificar Comando",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Identificar Comando": {
      "main": [
        [
          {
            "node": "Obtener Productos",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener Carrito",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Obtener Ã“rdenes",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Instrucciones de Pago",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "MenÃº de Ayuda",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Respuesta Predeterminada",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Productos": {
      "main": [
        [
          {
            "node": "Formatear Productos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Productos": {
      "main": [
        [
          {
            "node": "Responder al Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Carrito": {
      "main": [
        [
          {
            "node": "Formatear Carrito",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Carrito": {
      "main": [
        [
          {
            "node": "Responder al Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Obtener Ã“rdenes": {
      "main": [
        [
          {
            "node": "Formatear Ã“rdenes",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatear Ã“rdenes": {
      "main": [
        [
          {
            "node": "Responder al Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instrucciones de Pago": {
      "main": [
        [
          {
            "node": "Responder al Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MenÃº de Ayuda": {
      "main": [
        [
          {
            "node": "Responder al Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Respuesta Predeterminada": {
      "main": [
        [
          {
            "node": "Responder al Usuario",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {},
  "versionId": "1",
  "id": "ecommerce-chatbot",
  "meta": {
    "instanceId": "ecommerce"
  },
  "tags": []
}
